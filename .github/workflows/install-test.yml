name: Installation Test

on:
  pull_request:
    branches: [ main ]
    paths: 
      - 'bin/**'
      - 'scripts/**'
      - 'package.json'
      - 'checksums.json'
  push:
    branches: [ main ]
    paths:
      - 'bin/**'
      - 'scripts/**'
      - 'package.json'
      - 'checksums.json'

jobs:
  test-installation:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18, 20, 21]
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    # Test 1: Test the scripts directly without actually downloading
    - name: Test platform detection
      run: node scripts/postinstall.cjs
      env:
        # Mock version to prevent actual download during CI
        LLPM_TEST_MODE: true
        
    - name: Test CLI stub
      run: |
        # Test that CLI stub fails gracefully when binary missing
        if node bin/llpm.cjs --help 2>/dev/null; then
          echo "❌ CLI stub should fail when binary missing"
          exit 1
        else
          echo "✅ CLI stub correctly reports missing binary"
        fi
      
    # Test 2: Simulate npm install in a clean environment
    - name: Create test project
      run: |
        mkdir test-install
        cd test-install
        npm init -y
        
    - name: Test package installation (dry run)
      run: |
        cd test-install
        # Create a local tarball to test installation
        cd ..
        npm pack
        cd test-install
        # Install from local tarball (will skip download due to no releases)
        npm install ../llpm-*.tgz || echo "Expected failure - no releases exist yet"
        
    # Test 3: Verify stub script exists and is executable
    - name: Verify installation files
      run: |
        ls -la bin/
        file bin/llpm.cjs
        # Test that CLI stub fails gracefully when binary missing
        if node bin/llpm.cjs --version 2>/dev/null; then
          echo "❌ CLI stub should fail when binary missing"
          exit 1
        else
          echo "✅ CLI stub correctly reports missing binary"
        fi
        
  test-postinstall-script:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        
    - name: Install dependencies for testing
      run: npm install --ignore-scripts
      
    - name: Test postinstall script functions
      run: |
        node -e "
          const { detectPlatform, getPackageVersion, constructDownloadUrl } = require('./scripts/postinstall.cjs');
          
          // Test platform detection
          const platform = detectPlatform();
          console.log('Platform detection:', platform);
          
          // Test version reading
          const version = getPackageVersion();
          console.log('Package version:', version);
          
          // Test URL construction
          const url = constructDownloadUrl(version, platform.platform, platform.arch);
          console.log('Download URL:', url);
          
          console.log('✅ All postinstall script functions working');
        "
        
    - name: Test CLI stub functions
      run: |
        node -e "
          const { findBinaryPath } = require('./bin/llpm.cjs');
          
          try {
            findBinaryPath();
          } catch (err) {
            if (err.message.includes('not found')) {
              console.log('✅ CLI stub correctly detects missing binary');
            } else {
              throw err;
            }
          }
        "
        
  test-package-metadata:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate package.json
      run: |
        node -e "
          const pkg = require('./package.json');
          
          // Verify required fields for npm publishing
          if (!pkg.name || pkg.name !== 'llpm') throw new Error('Invalid name');
          if (!pkg.version) throw new Error('Missing version');
          if (!pkg.description) throw new Error('Missing description');
          if (!pkg.keywords || !Array.isArray(pkg.keywords)) throw new Error('Missing keywords');
          if (!pkg.author) throw new Error('Missing author');
          if (!pkg.license) throw new Error('Missing license');
          if (!pkg.repository) throw new Error('Missing repository');
          if (pkg.private === true) throw new Error('Package should not be private');
          if (!pkg.bin || !pkg.bin.llpm) throw new Error('Missing bin entry');
          if (!pkg.scripts || !pkg.scripts.postinstall) throw new Error('Missing postinstall script');
          
          console.log('✅ package.json validation passed');
        "
        
    - name: Test checksums file
      run: |
        node -e "
          const checksums = require('./checksums.json');
          
          if (!checksums.version) throw new Error('Missing version in checksums');
          if (!checksums.checksums) throw new Error('Missing checksums object');
          
          const expected = [
            'llpm-windows-x64.tar.gz',
            'llpm-windows-arm64.tar.gz', 
            'llpm-macos-x64.tar.gz',
            'llpm-macos-arm64.tar.gz',
            'llpm-linux-x64.tar.gz',
            'llpm-linux-arm64.tar.gz'
          ];
          
          for (const file of expected) {
            if (!checksums.checksums[file]) throw new Error('Missing checksum for ' + file);
          }
          
          console.log('✅ checksums.json validation passed');
        "