name: Installation Test

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'bin/**'
      - 'package.json'
      - 'index.ts'
      - 'src/**'
  push:
    branches: [ main ]
    paths:
      - 'bin/**'
      - 'package.json'
      - 'index.ts'
      - 'src/**'

jobs:
  test-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: oven-sh/setup-bun@v2

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build JS bundle
      run: bun run build

    - name: Verify bundle exists and is non-empty
      run: |
        test -f dist/llpm.js || { echo "FAIL: dist/llpm.js not found"; exit 1; }
        test -s dist/llpm.js || { echo "FAIL: dist/llpm.js is empty"; exit 1; }
        echo "Bundle size: $(du -h dist/llpm.js | cut -f1)"

    - name: Verify bundle loads on Node
      run: |
        node -e "import('./dist/llpm.js').catch(() => {})" 2>&1 || true
        echo "Bundle loaded successfully (TTY error is expected in CI)"

  test-node-compat:
    strategy:
      matrix:
        node-version: [18, 20, 22]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: oven-sh/setup-bun@v2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build JS bundle
      run: bun run build

    - name: Test CLI wrapper
      run: |
        node bin/llpm.cjs 2>&1 || true
        echo "CLI wrapper executed (TTY error is expected in CI)"

  test-package-metadata:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate package.json
      run: |
        node -e "
          const pkg = require('./package.json');

          if (!pkg.name || pkg.name !== '@britt/llpm') throw new Error('Invalid name');
          if (!pkg.version) throw new Error('Missing version');
          if (!pkg.description) throw new Error('Missing description');
          if (!pkg.keywords || !Array.isArray(pkg.keywords)) throw new Error('Missing keywords');
          if (!pkg.author) throw new Error('Missing author');
          if (!pkg.license) throw new Error('Missing license');
          if (!pkg.repository) throw new Error('Missing repository');
          if (pkg.private === true) throw new Error('Package should not be private');
          if (!pkg.bin || !pkg.bin.llpm) throw new Error('Missing bin entry');
          if (pkg.scripts.postinstall) throw new Error('postinstall script should not exist');
          if (!pkg.files.includes('dist/llpm.js')) throw new Error('Missing dist/llpm.js in files');
          if (!pkg.files.includes('skills/')) throw new Error('Missing skills/ in files');

          console.log('package.json validation passed');
        "

    - name: Verify no postinstall artifacts
      run: |
        test ! -f scripts/postinstall.cjs || { echo "FAIL: postinstall.cjs still exists"; exit 1; }
        test ! -f checksums.json || { echo "FAIL: checksums.json still exists"; exit 1; }
        echo "No postinstall artifacts found"

  test-npm-pack:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: oven-sh/setup-bun@v2

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build JS bundle
      run: bun run build

    - name: Test npm pack
      run: |
        npm pack --dry-run 2>&1 | tee pack-output.txt
        grep "dist/llpm.js" pack-output.txt || { echo "FAIL: dist/llpm.js not in package"; exit 1; }
        grep "bin/llpm.cjs" pack-output.txt || { echo "FAIL: bin/llpm.cjs not in package"; exit 1; }
        echo "npm pack contents verified"

  test-npm-install:
    strategy:
      matrix:
        node-version: [18, 20, 22]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: oven-sh/setup-bun@v2

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Build JS bundle
      run: bun run build

    - name: Pack tarball
      run: npm pack

    - name: Install from tarball
      run: |
        TARBALL=$(ls britt-llpm-*.tgz)
        echo "Installing from $TARBALL"
        npm install -g "./$TARBALL"

    - name: Verify llpm is in PATH
      run: which llpm

    - name: Verify llpm runs
      run: |
        llpm 2>&1 || true
        echo "llpm binary executed (TTY/config error is expected in CI)"
