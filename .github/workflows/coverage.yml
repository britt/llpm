name: Coverage Report

on:
  pull_request:
    branches: [ main ]

# Permissions needed for commenting on PRs
permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    # Make coverage job non-blocking - continue even if this fails
    continue-on-error: true

    steps:
    - uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Run tests with coverage
      # Make test step non-blocking too
      continue-on-error: true
      env:
        # Provide test environment variables to prevent validation errors
        OPENAI_API_KEY: test-key-for-coverage
        ANTHROPIC_API_KEY: test-key-for-coverage
        GROQ_API_KEY: test-key-for-coverage
        GOOGLE_VERTEX_PROJECT_ID: test-project-for-coverage
      run: bun run test --coverage

    - name: Generate coverage summary
      if: success()
      run: |
        # Generate a markdown coverage report from the console output
        echo "## ðŸ“Š Test Coverage Report" > coverage-summary.md
        echo "" >> coverage-summary.md
        
        # Capture the coverage output
        bun run test --coverage --run > coverage_output.log 2>&1
        
        # Extract test results
        TEST_COUNT=$(grep -o '[0-9]\+ passed' coverage_output.log | head -1 | grep -o '[0-9]\+')
        TEST_FILES=$(grep -o '[0-9]\+ passed ([0-9]\+)' coverage_output.log | head -1 || echo "")
        
        echo "**Tests:** $TEST_COUNT passed âœ…" >> coverage-summary.md
        if [ ! -z "$TEST_FILES" ]; then
          echo "**Test Files:** $TEST_FILES" >> coverage-summary.md
        fi
        echo "" >> coverage-summary.md
        
        # Extract and format overall coverage
        OVERALL_COVERAGE=$(grep "All files" coverage_output.log | head -1)
        if [ ! -z "$OVERALL_COVERAGE" ]; then
          echo "### ðŸŽ¯ Overall Coverage" >> coverage-summary.md
          echo "" >> coverage-summary.md
          echo '```' >> coverage-summary.md
          echo "$OVERALL_COVERAGE" >> coverage-summary.md
          echo '```' >> coverage-summary.md
          echo "" >> coverage-summary.md
        fi
        
        # Extract coverage table - improved approach
        echo "### ðŸ“‹ Detailed Coverage" >> coverage-summary.md
        echo "" >> coverage-summary.md
        echo '```' >> coverage-summary.md
        awk '/% Coverage report from v8/,/^$/' coverage_output.log | grep -v '^$' >> coverage-summary.md
        echo '```' >> coverage-summary.md
        echo "" >> coverage-summary.md
        echo "---" >> coverage-summary.md
        echo "*Generated on: $(date)*" >> coverage-summary.md
      env:
        OPENAI_API_KEY: test-key-for-coverage
        ANTHROPIC_API_KEY: test-key-for-coverage
        GROQ_API_KEY: test-key-for-coverage
        GOOGLE_VERTEX_PROJECT_ID: test-project-for-coverage

    - name: Comment PR with coverage
      if: success() && github.event_name == 'pull_request'
      uses: thollander/actions-comment-pull-request@v2
      with:
        filePath: coverage-summary.md
        comment_tag: coverage-report
        mode: recreate

    - name: Upload coverage to Codecov
      # Only upload if tests succeeded and token is available
      if: success() && env.CODECOV_TOKEN != ''
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}